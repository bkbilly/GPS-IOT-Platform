<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Management - GPS Fleet Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="css/device-management.css">
</head>
<body>

<div class="container">
    <div class="header">
        <div class="header-title">
            <a href="gps-dashboard.html" class="back-btn">&#8592;</a>
            <div>
                <h1>Device Management</h1>
                <p style="color:var(--text-muted);margin-top:0.5rem;">Configure and manage your GPS devices</p>
            </div>
        </div>
        <div style="display:flex;gap:1rem;">
            <a href="user-settings.html" class="btn btn-secondary">&#9881;&#65039; User Settings</a>
            <button class="btn btn-primary" onclick="openAddDeviceModal()">&#10133; Add New Device</button>
        </div>
    </div>

    <div id="alertContainer"></div>

    <!-- Searchable device table -->
    <div class="devices-table-wrap">
        <div class="devices-search-bar">
            <div class="search-input-wrap">
                <span class="search-icon">&#128269;</span>
                <input type="text" id="deviceSearch" class="search-input"
                    placeholder="Search by name, IMEI, plate, protocol&#8230;"
                    oninput="filterDevices()">
            </div>
            <span class="devices-count" id="devicesCount"></span>
        </div>
        <div style="overflow-x:auto;">
            <table class="devices-table">
                <thead>
                    <tr>
                        <th style="width:44px;"></th>
                        <th>Name</th>
                        <th>IMEI</th>
                        <th>Protocol</th>
                        <th>Plate</th>
                        <th>Status</th>
                        <th>Last Seen</th>
                        <th>Odometer</th>
                        <th style="width:180px;text-align:center;">Actions</th>
                    </tr>
                </thead>
                <tbody id="devicesTableBody">
                    <tr id="devicesLoadingRow">
                        <td colspan="9" style="text-align:center;padding:3rem;color:var(--text-muted);">
                            <div class="loading" style="margin:0 auto 1rem;"></div>
                            Loading devices&#8230;
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- =============================================================
     DEVICE MODAL  (General | Alerts | Raw Data)
============================================================= -->
<div class="modal" id="deviceModal">
    <div class="modal-content wide">
        <form id="deviceForm" onsubmit="handleSubmit(event)" style="display:flex;flex-direction:column;height:100%;">

            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Device</h2>
                <button type="button" class="modal-close" onclick="closeDeviceModal()">&#10005;</button>
            </div>

            <div class="modal-tabs">
                <button type="button" class="modal-tab active" data-tab="general" onclick="switchModalTab('general',this)">&#128203; General</button>
                <button type="button" class="modal-tab" data-tab="alerts"  onclick="switchModalTab('alerts',this)">&#128276; Alerts</button>
                <button type="button" class="modal-tab" data-tab="rawdata" onclick="switchModalTab('rawdata',this)">&#128202; Raw Data</button>
            </div>

            <div class="modal-scrollable">

                <!-- TAB: GENERAL -->
                <div class="modal-tab-content active" id="tab-general">
                    <div class="form-main-layout">
                        <div class="form-column">
                            <div class="form-group">
                                <label class="form-label">Device Name *</label>
                                <input type="text" class="form-input" id="deviceName" required placeholder="e.g. Truck #1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">IMEI *</label>
                                <input type="text" class="form-input" id="deviceImei" required placeholder="15-digit IMEI">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Protocol</label>
                                <select class="form-input" id="deviceProtocol"></select>
                            </div>
                        </div>
                        <div class="form-column">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Vehicle Type</label>
                                    <select class="form-input" id="vehicleType">
                                        <option value="car">&#128663; Car</option>
                                        <option value="truck">&#128667; Truck</option>
                                        <option value="van">&#128656; Van</option>
                                        <option value="motorcycle">&#127949;&#65039; Motorcycle</option>
                                        <option value="bus">&#128652; Bus</option>
                                        <option value="person">&#128694; Personal Tracker</option>
                                        <option value="airplane">&#9992;&#65039; Airplane</option>
                                        <option value="bicycle">&#128690; Bicycle</option>
                                        <option value="boat">&#128674; Boat / Marine</option>
                                        <option value="scooter">&#128756; Scooter</option>
                                        <option value="tractor">&#128668; Tractor</option>
                                        <option value="arrow">&#9650; Arrow</option>
                                        <option value="other">&#128230; Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Plate</label>
                                    <input type="text" class="form-input" id="licensePlate" placeholder="ABC-123">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">VIN</label>
                                <input type="text" class="form-input" id="vin" placeholder="17-character VIN">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    Current Odometer (km)
                                    <span style="font-size:0.8rem;color:var(--text-muted);font-weight:normal;display:block;margin-top:0.25rem;">Adjust only if resetting or correcting</span>
                                </label>
                                <input type="number" id="currentOdometer" class="form-input" placeholder="0" step="0.1" min="0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    Offline Threshold (hours)
                                    <span style="font-size:0.8rem;color:var(--text-muted);font-weight:normal;display:block;margin-top:0.25rem;">Hours without data before vehicle is considered offline</span>
                                </label>
                                <input type="number" id="offlineTimeoutHours" class="form-input" placeholder="24" step="1" min="1" value="24">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB: ALERTS -->
                <div class="modal-tab-content" id="tab-alerts">
                    <div class="alerts-add-row">
                        <div class="alerts-add-panel">
                            <div class="alerts-add-panel-label">&#128226; Add System Alert</div>
                            <div style="display:flex;gap:0.5rem;">
                                <select class="form-input" id="addAlertSelect" style="flex:1;"></select>
                                <button type="button" class="btn btn-primary" onclick="addSelectedAlert()">Add</button>
                            </div>
                        </div>
                        <div class="alerts-add-divider"></div>
                        <div class="alerts-add-panel">
                            <div class="alerts-add-panel-label">&#9889; Add Custom Rule</div>
                            <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
                                <input type="text" id="newRuleName" class="form-input" placeholder="Name" style="flex:1;min-width:100px;">
                                <input type="text" id="newRuleCond" class="form-input" placeholder="speed &gt; 80 and ignition" style="flex:2;min-width:180px;">
                                <button type="button" class="btn btn-secondary" onclick="addCustomRule()">Add</button>
                            </div>
                            <details style="margin-top:0.5rem;">
                                <summary style="cursor:pointer;color:var(--text-muted);font-size:0.8rem;">&#8505;&#65039; Syntax reference</summary>
                                <div style="margin-top:0.5rem;padding:0.75rem;background:var(--bg-secondary);border-radius:8px;font-size:0.78rem;line-height:1.8;color:var(--text-muted);">
                                    <strong style="color:var(--text-secondary);">Attributes:</strong> speed, ignition, satellites, altitude, battery_voltage, fuel_level, temperature, door_open<br>
                                    <strong style="color:var(--text-secondary);">Operators:</strong> &gt; &lt; == != &gt;= &lt;= and or not
                                </div>
                            </details>
                        </div>
                    </div>

                    <div class="alerts-table-wrap">
                        <table class="alerts-table">
                            <thead>
                                <tr>
                                    <th style="width:34px;">#</th>
                                    <th style="width:190px;">Alert Type</th>
                                    <th>Threshold</th>
                                    <th>Notify Via</th>
                                    <th style="width:160px;">Schedule</th>
                                    <th style="width:84px;text-align:center;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="alertsTableBody">
                                <tr id="alertsEmptyRow">
                                    <td colspan="6" class="alerts-empty">No alerts configured. Use the controls above to add one.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- TAB: RAW DATA -->
                <div class="modal-tab-content" id="tab-rawdata">
                    <div style="overflow-x:auto;">
                        <table class="raw-data-table">
                            <thead>
                                <tr>
                                    <th>Time</th><th>Lat</th><th>Lon</th><th>Speed</th>
                                    <th>Heading</th><th>Sat</th><th>Alt</th><th>Ign</th><th>Attributes</th>
                                </tr>
                            </thead>
                            <tbody id="rawDataBody"></tbody>
                        </table>
                    </div>
                    <div class="pagination">
                        <button type="button" class="btn btn-secondary" id="prevPageBtn" onclick="changeRawDataPage(-1)">Previous</button>
                        <span class="page-info" id="pageInfo"></span>
                        <button type="button" class="btn btn-secondary" id="nextPageBtn" onclick="changeRawDataPage(1)">Next</button>
                    </div>
                </div>

            </div><!-- /.modal-scrollable -->

            <!-- PERSISTENT FOOTER -->
            <div class="modal-footer">
                <div style="display:flex;gap:0.75rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeDeviceModal()">Cancel</button>
                    <button type="button" class="btn btn-danger" id="deleteDeviceBtn" onclick="deleteCurrentDevice()" style="display:none;">&#128465;&#65039; Delete</button>
                </div>
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    <span id="submitText">Save Changes</span>
                    <span id="submitLoading" class="loading" style="display:none;"></span>
                </button>
            </div>

        </form>
    </div>
</div>

<!-- =============================================================
     ALERT EDITOR MODAL
============================================================= -->
<div class="modal" id="alertEditorModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="alertEditorTitle">Edit Alert</h2>
            <button type="button" class="modal-close" onclick="closeAlertEditor()">&#10005;</button>
        </div>
        <div id="alertEditorBody"></div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeAlertEditor()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveAlertFromEditor()">Save Alert</button>
        </div>
    </div>
</div>

<!-- =============================================================
     COMMANDS MODAL
============================================================= -->
<div class="modal" id="commandModal">
    <div class="modal-content wide">
        <div class="modal-header">
            <h2 class="modal-title">Device Commands &#8211; <span id="commandDeviceName"></span></h2>
            <button type="button" class="modal-close" onclick="closeCommandModal()">&#10005;</button>
        </div>

        <div class="modal-scrollable">
            <div class="command-tabs">
                <button class="command-tab active" onclick="switchCommandTab('send')">&#128228; Send Command</button>
                <button class="command-tab" onclick="switchCommandTab('history')">&#128220; History</button>
            </div>

            <!-- Send Command Tab -->
            <div class="command-tab-content active" id="sendCommandTab">
                <div class="command-subtabs">
                    <button class="command-subtab active" onclick="switchCommandSubtab('predefined')">Predefined Commands</button>
                    <button class="command-subtab" onclick="switchCommandSubtab('custom')">Custom Command</button>
                </div>

                <!-- Predefined Commands -->
                <div class="command-subtab-content active" id="predefinedCommandContent">
                    <div class="form-group">
                        <label class="form-label">Select Command</label>
                        <select class="form-select" id="commandTypeSelect" onchange="onCommandSelect()">
                            <option value="">-- Select a command --</option>
                        </select>
                    </div>

                    <div id="commandInfoBox" class="command-info-box" style="display:none;">
                        <div class="command-info-label">Description:</div>
                        <div id="commandDescription"></div>
                        <div class="command-info-label" style="margin-top:0.75rem;">Example:</div>
                        <div id="commandExample" style="font-family:var(--font-mono);background:var(--bg-tertiary);padding:0.5rem;border-radius:6px;margin-top:0.25rem;"></div>
                    </div>

                    <div id="commandParamsBox" class="form-group" style="display:none;">
                        <label class="form-label">Parameters</label>
                        <input type="text" class="form-input" id="commandParams" placeholder="Enter parameters here">
                        <div style="font-size:0.8125rem;color:var(--text-muted);margin-top:0.5rem;">Parameters will be appended after the command with a space</div>
                    </div>

                    <div id="commandPreviewBox" class="command-preview-box" style="display:none;">
                        <div class="command-preview-label">Data to be sent:</div>
                        <div id="commandPreviewHex" class="command-preview-hex"></div>
                        <div id="commandPreviewAscii" class="command-preview-ascii"></div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="previewCommand()">&#128269; Preview</button>
                        <button type="button" class="btn btn-primary" onclick="sendCommand()" id="sendCommandBtn">&#128228; Send Command</button>
                    </div>
                </div>

                <!-- Custom Command -->
                <div class="command-subtab-content" id="customCommandContent">
                    <div class="form-group">
                        <label class="form-label">Custom Command</label>
                        <textarea class="form-textarea" id="customCommandInput" placeholder="Enter raw command text or hex string" rows="3"></textarea>
                        <div style="font-size:0.875rem;color:var(--text-muted);margin-top:0.5rem;">Enter plain text or hex string (will be automatically converted to bytes)</div>
                    </div>

                    <div id="customCommandPreviewBox" class="command-preview-box" style="display:none;">
                        <div class="command-preview-label">Data to be sent:</div>
                        <div id="customCommandPreviewHex" class="command-preview-hex"></div>
                        <div id="customCommandPreviewAscii" class="command-preview-ascii"></div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="previewCustomCommand()">&#128269; Preview</button>
                        <button type="button" class="btn btn-primary" onclick="sendCustomCommand()" id="sendCustomCommandBtn">&#128228; Send Custom Command</button>
                    </div>
                </div>
            </div>

            <!-- History Tab -->
            <div class="command-tab-content" id="historyCommandTab">
                <div style="margin-bottom:1rem;">
                    <button class="btn btn-secondary" onclick="refreshCommandHistory()">&#128260; Refresh</button>
                </div>
                <div style="overflow-x:auto;">
                    <table class="command-history-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Command</th>
                                <th>Payload</th>
                                <th>Status</th>
                                <th>Response</th>
                            </tr>
                        </thead>
                        <tbody id="commandHistoryBody"></tbody>
                    </table>
                </div>
                <div id="commandHistoryEmpty" style="display:none;text-align:center;padding:3rem;color:var(--text-muted);">
                    <div style="font-size:3rem;margin-bottom:1rem;">&#128237;</div>
                    <div>No command history available</div>
                </div>
            </div>
        </div><!-- /.modal-scrollable -->

    </div>
</div>

<!-- Toast container (required by device-commands.js) -->
<div class="toast-container" id="toastContainer"></div>

<script src="js/config.js"></script>
<script src="js/device-management.js"></script>
<script src="js/device-commands.js"></script>
</body>
</html>