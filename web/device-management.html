<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Management - GPS Fleet Tracker</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/device-management.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-title">
                <a href="gps-dashboard.html" class="back-btn">‚Üê</a>
                <div>
                    <h1>Device Management</h1>
                    <p style="color: var(--text-muted); margin-top: 0.5rem;">Configure and manage your GPS devices</p>
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem;">
                <a href="user-settings.html" class="btn btn-secondary">
                    ‚öôÔ∏è User Settings
                </a>
                <button class="btn btn-primary" onclick="openAddDeviceModal()">
                    ‚ûï Add New Device
                </button>
            </div>
        </div>
        
        <div id="alertContainer"></div>
        
        <div class="devices-grid" id="devicesGrid">
            <!-- Devices will be loaded here -->
        </div>
    </div>
    
    <!-- Add/Edit Device Modal -->
    <div class="modal" id="deviceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Device</h2>
                <button class="modal-close" onclick="closeDeviceModal()">‚úï</button>
            </div>
            
            <form id="deviceForm" onsubmit="handleSubmit(event)">
                <div class="form-main-layout">
                    <!-- Column 1: General Info -->
                    <div class="form-column">
                        <div class="form-group">
                            <label class="form-label">Device Name *</label>
                            <input type="text" class="form-input" id="deviceName" required placeholder="e.g. Delivery Van 1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">IMEI *</label>
                            <input type="text" class="form-input" id="deviceImei" required placeholder="15-20 digits">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Protocol *</label>
                            <select class="form-select" id="deviceProtocol" required>
                                <option value="">-- Select Protocol --</option>
                            </select>

                            <div style="font-size: 0.8125rem; color: var(--text-muted); margin-top: 0.5rem;">
                                Select the protocol that matches your GPS device model
                            </div>
                        </div>
                        
                        <div class="config-section">
                            <h3 class="config-title">Vehicle Details</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Type</label>
                                    <select class="form-select" id="vehicleType">
                                        <option value="car">üöó Car</option>
                                        <option value="truck">üöõ Truck</option>
                                        <option value="van">üöê Van</option>
                                        <option value="motorcycle">üèçÔ∏è Motorcycle</option>
                                        <option value="bus">üöå Bus</option>
                                        <option value="person">üö∂ Personal Tracker</option>
                                        <option value="airplane">‚úàÔ∏è Airplane</option>
                                        <option value="bicycle">üö≤ Bicycle</option>
                                        <option value="boat">üö¢ Boat / Marine</option>
                                        <option value="scooter">üõ¥ Scooter</option>
                                        <option value="tractor">üöú Tractor</option>
                                        <option value="arrow">‚ñ≤ Arrow (Directional)</option>
                                        <option value="other">üì¶ Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Plate</label>
                                    <input type="text" class="form-input" id="licensePlate" placeholder="ABC-123">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">VIN</label>
                                <input type="text" class="form-input" id="vin" placeholder="17-character VIN">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                Current Odometer (km)
                                <span style="font-size: 0.75rem; color: var(--text-muted); font-weight: normal;">
                                    <div style="font-size: 0.8125rem; color: var(--text-muted); margin-top: 0.5rem;">
                                        Adjust only if resetting or correcting the value
                                    </div>
                                </span>
                            </label>
                            <input type="number" id="currentOdometer" class="form-input" placeholder="0" step="0.1" min="0">
                        </div>

                        <div class="config-section">
                            <h3 class="config-title">Maintenance</h3>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                                <div class="form-group"><label class="form-label">Oil (km)</label><input type="number" class="form-input" id="oilChangeKm"></div>
                                <div class="form-group"><label class="form-label">Tire (km)</label><input type="number" class="form-input" id="tireRotationKm"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Column 2: Alerts -->
                    <div class="form-column">
                        <div class="config-section">
                            <h3 class="config-title">Alert & Channel Rules</h3>
                            <div id="activeAlertsList" class="alert-config-list">
                                <!-- Alert items will be added here -->
                            </div>
                            
                            <div class="alert-add-container">
                                <select class="form-input" id="addAlertSelect" style="flex:1;"></select>
                                <button type="button" class="btn btn-secondary" onclick="addSelectedAlert()">Add</button>
                            </div>
                            <div style="margin-top:1.5rem; padding-top:1rem; border-top:1px solid var(--border-color);">
                                <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 1rem;">
                                    <h4 style="font-size: 1rem; margin: 0;">Custom Rules</h4>
                                </div>
                                <div id="customRulesList" class="alert-config-list"></div>
                                <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-top: 1rem;">
                                    <input type="text" id="newRuleName" class="form-input" placeholder="Rule Name">
                                    <div style="display: flex; gap: 0.5rem;">
                                        <input type="text" id="newRuleCond" class="form-input" placeholder="Condition e.g. speed > 120">
                                        <button type="button" class="btn btn-secondary" onclick="addCustomRule()">Add</button>
                                    </div>
                                    
                                    <!-- Examples Section -->
                                    <details style="margin-top: 0.5rem;">
                                        <summary style="cursor: pointer; color: var(--text-muted); font-size: 0.8125rem; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 6px;">
                                            üìö View Examples
                                        </summary>
                                        <div style="margin-top: 0.75rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 6px; font-size: 0.8125rem; color: var(--text-secondary); line-height: 1.8;">
                                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">Simple Conditions:</div>
                                            <div style="font-family: var(--font-mono); margin-left: 1rem;">
                                                ‚Ä¢ <code>speed > 120</code> - Speeding over 120 km/h<br>
                                                ‚Ä¢ <code>speed < 10 and ignition</code> - Idling (slow + engine on)<br>
                                                ‚Ä¢ <code>not ignition</code> - Engine off<br>
                                                ‚Ä¢ <code>satellites < 4</code> - Poor GPS signal
                                            </div>
                                            
                                            <div style="font-weight: 600; color: var(--text-primary); margin-top: 1rem; margin-battery: 0.5rem;">Combined Conditions:</div>
                                            <div style="font-family: var(--font-mono); margin-left: 1rem;">
                                                ‚Ä¢ <code>speed > 100 and ignition</code> - High speed while driving<br>
                                                ‚Ä¢ <code>speed > 80 and satellites < 5</code> - Speeding with poor GPS<br>
                                                ‚Ä¢ <code>ignition and speed == 0</code> - Stopped with engine on<br>
                                                ‚Ä¢ <code>speed > 50 and not ignition</code> - Towing detection<br>
                                                ‚Ä¢ <code>speed > 0 and satellites < 3</code> - Moving with bad GPS
                                            </div>
                                            
                                            <div style="font-weight: 600; color: var(--text-primary); margin-top: 1rem; margin-bottom: 0.5rem;">Sensor-Based Rules:</div>
                                            <div style="font-family: var(--font-mono); margin-left: 1rem;">
                                                ‚Ä¢ <code>speed > 60 and fuel_level < 10</code> - Low fuel while driving<br>
                                                ‚Ä¢ <code>ignition and battery_voltage < 11</code> - Low battery warning<br>
                                                ‚Ä¢ <code>temperature > 80 and speed > 0</code> - Engine overheating<br>
                                                ‚Ä¢ <code>door_open and speed > 0</code> - Door open while moving<br>
                                                ‚Ä¢ <code>fuel_level < 5 and speed > 0</code> - Critical fuel level
                                            </div>
                                            
                                            <div style="font-weight: 600; color: var(--text-primary); margin-top: 1rem; margin-bottom: 0.5rem;">Advanced Combinations:</div>
                                            <div style="font-family: var(--font-mono); margin-left: 1rem;">
                                                ‚Ä¢ <code>speed > 100 and ignition and satellites < 5</code> - Fast + poor GPS<br>
                                                ‚Ä¢ <code>ignition and speed < 5 and fuel_level < 20</code> - Idling low fuel<br>
                                                ‚Ä¢ <code>speed > 0 and not ignition and satellites > 3</code> - Towing w/ good GPS<br>
                                                ‚Ä¢ <code>temperature > 90 and speed > 80 and ignition</code> - Hot + fast<br>
                                                ‚Ä¢ <code>battery_voltage < 11.5 and ignition and speed < 10</code> - Battery issue
                                            </div>
                                            
                                            <div style="font-weight: 600; color: var(--text-primary); margin-top: 1rem; margin-bottom: 0.5rem;">Available Attributes:</div>
                                            <div style="margin-left: 1rem; color: var(--text-muted);">
                                                <code>speed</code>, <code>ignition</code>, <code>satellites</code>, <code>altitude</code>, 
                                                <code>course</code>, <code>battery_voltage</code>, <code>fuel_level</code>, 
                                                <code>temperature</code>, <code>door_open</code>, and any custom sensor attributes
                                            </div>
                                            
                                            <div style="font-weight: 600; color: var(--text-primary); margin-top: 1rem; margin-bottom: 0.5rem;">Operators:</div>
                                            <div style="margin-left: 1rem; color: var(--text-muted);">
                                                <code>></code> <code><</code> <code>==</code> <code>!=</code> <code>>=</code> <code><=</code><br>
                                                <code>and</code> <code>or</code> <code>not</code>
                                            </div>
                                        </div>
                                    </details>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <div style="display: flex; gap: 1rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeDeviceModal()">Cancel</button>
                        <button type="button" class="btn btn-danger" id="deleteDeviceBtn" onclick="deleteCurrentDevice()" style="display: none;">
                            üóëÔ∏è Delete Device
                        </button>
                    </div>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <span id="submitText">Save Changes</span>
                        <span id="submitLoading" class="loading" style="display:none;"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Raw Data Modal -->
    <div class="modal" id="rawDataModal">
        <div class="modal-content wide">
            <div class="modal-header">
                <h2 class="modal-title">Raw History</h2>
                <button class="modal-close" onclick="closeRawDataModal()">‚úï</button>
            </div>
            <div style="overflow-x:auto;">
                <table class="raw-data-table">
                    <thead><tr><th>Time</th><th>Lat</th><th>Lon</th><th>Speed</th><th>Heading</th><th>Sat</th><th>Alt</th><th>Ign</th><th>Attributes</th></tr></thead>
                    <tbody id="rawDataBody"></tbody>
                </table>
            </div>
            <div class="pagination">
                <button class="btn btn-secondary" id="prevPageBtn" onclick="changeRawDataPage(-1)">Previous</button>
                <span class="page-info" id="pageInfo"></span>
                <button class="btn btn-secondary" id="nextPageBtn" onclick="changeRawDataPage(1)">Next</button>
            </div>
        </div>
    </div>

    <!-- Command Modal -->
    <div class="modal" id="commandModal">
        <div class="modal-content wide">
            <div class="modal-header">
                <h2 class="modal-title">Device Commands - <span id="commandDeviceName"></span></h2>
                <button class="modal-close" onclick="closeCommandModal()">‚úï</button>
            </div>
            
            <!-- Tabs -->
            <div class="command-tabs">
                <button class="command-tab active" onclick="switchCommandTab('send')">üì§ Send Command</button>
                <button class="command-tab" onclick="switchCommandTab('history')">üìú History</button>
            </div>
            
            <!-- Send Command Tab -->
            <div class="command-tab-content active" id="sendCommandTab">
                <div class="command-subtabs">
                    <button class="command-subtab active" onclick="switchCommandSubtab('predefined')">Predefined Commands</button>
                    <button class="command-subtab" onclick="switchCommandSubtab('custom')">Custom Command</button>
                </div>
                
                <!-- Predefined Commands -->
                <div class="command-subtab-content active" id="predefinedCommandContent">
                    <div class="form-group">
                        <label class="form-label">Select Command</label>
                        <select class="form-select" id="commandTypeSelect" onchange="onCommandSelect()">
                            <option value="">-- Select a command --</option>
                        </select>
                    </div>
                    
                    <div id="commandInfoBox" class="command-info-box" style="display: none;">
                        <div class="command-info-label">Description:</div>
                        <div id="commandDescription"></div>
                        <div class="command-info-label" style="margin-top: 0.75rem;">Example:</div>
                        <div id="commandExample" style="font-family: var(--font-mono); background: var(--bg-tertiary); padding: 0.5rem; border-radius: 6px; margin-top: 0.25rem;"></div>
                    </div>
                    
                    <div id="commandParamsBox" class="form-group" style="display: none;">
                        <label class="form-label">Parameters</label>
                        <input type="text" class="form-input" id="commandParams" placeholder="Enter parameters here">
                        <div style="font-size: 0.8125rem; color: var(--text-muted); margin-top: 0.5rem;">
                            Parameters will be appended after the command with a space
                        </div>
                    </div>
                    
                    <div id="commandPreviewBox" class="command-preview-box" style="display: none;">
                        <div class="command-preview-label">Data to be sent:</div>
                        <div id="commandPreviewHex" class="command-preview-hex"></div>
                        <div id="commandPreviewAscii" class="command-preview-ascii"></div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="previewCommand()">üîç Preview</button>
                        <button type="button" class="btn btn-primary" onclick="sendCommand()" id="sendCommandBtn">
                            üì° Send Command
                        </button>
                    </div>
                </div>
                
                <!-- Custom Command -->
                <div class="command-subtab-content" id="customCommandContent">
                    <div class="form-group">
                        <label class="form-label">Custom Command</label>
                        <textarea class="form-textarea" id="customCommandInput" placeholder="Enter raw command text or hex string" rows="3"></textarea>
                        <div style="font-size: 0.875rem; color: var(--text-muted); margin-top: 0.5rem;">
                            Enter plain text or hex string (will be automatically converted to bytes)
                        </div>
                    </div>
                    
                    <div id="customCommandPreviewBox" class="command-preview-box" style="display: none;">
                        <div class="command-preview-label">Data to be sent:</div>
                        <div id="customCommandPreviewHex" class="command-preview-hex"></div>
                        <div id="customCommandPreviewAscii" class="command-preview-ascii"></div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="previewCustomCommand()">üîç Preview</button>
                        <button type="button" class="btn btn-primary" onclick="sendCustomCommand()" id="sendCustomCommandBtn">
                            üì° Send Custom Command
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- History Tab -->
            <div class="command-tab-content" id="historyCommandTab">
                <div style="margin-bottom: 1rem;">
                    <button class="btn btn-secondary" onclick="refreshCommandHistory()">üîÑ Refresh</button>
                </div>
                
                <div style="overflow-x:auto;">
                    <table class="command-history-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Command</th>
                                <th>Payload</th>
                                <th>Status</th>
                                <th>Response</th>
                            </tr>
                        </thead>
                        <tbody id="commandHistoryBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
                
                <div id="commandHistoryEmpty" style="display: none; text-align: center; padding: 3rem; color: var(--text-muted);">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div>
                    <div>No command history available</div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <!-- Scripts -->
    <script src="js/config.js"></script>
    <script src="js/device-management.js"></script>
    <script src="js/device-commands.js"></script>
</body>
</html>