<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Fleet Tracker</title>
    
    <!-- Leaflet for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Dark theme with vibrant accents */
            --bg-primary: #0a0e1a;
            --bg-secondary: #131825;
            --bg-tertiary: #1a2035;
            --bg-card: #1f2937;
            --bg-hover: #2a3447;
            
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            
            --accent-primary: #3b82f6;
            --accent-secondary: #8b5cf6;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;
            
            --border-color: #374151;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.5);
            
            --font-display: 'Outfit', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: var(--font-display);
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            overflow-x: hidden;
        }
        
        /* Animated gradient background */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(16, 185, 129, 0.05) 0%, transparent 50%);
            animation: gradientShift 20s ease infinite;
            z-index: -1;
            pointer-events: none;
        }
        
        @keyframes gradientShift {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(5%, 10%) rotate(5deg); }
            66% { transform: translate(-5%, 5%) rotate(-5deg); }
        }
        
        /* Layout */
        .dashboard {
            display: grid;
            grid-template-columns: 320px 1fr;
            grid-template-rows: 70px 1fr;
            height: 100vh;
            gap: 0;
            transition: grid-template-columns var(--transition-base), grid-template-rows var(--transition-base);
        }

        /* Desktop Sidebar Hidden */
        @media (min-width: 1025px) {
            .dashboard.sidebar-hidden {
                grid-template-columns: 0px 1fr;
            }
        }
        
        /* Header */
        .header {
            grid-column: 1 / -1;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            position: relative;
            z-index: 100;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: -0.02em;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            animation: pulseGlow 3s ease-in-out infinite;
        }
        
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.4); }
            50% { box-shadow: 0 0 30px rgba(59, 130, 246, 0.6); }
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .status-indicator {
            display: none; /* Hidden as requested */
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-success);
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }
        
        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 8px;
            font-family: var(--font-display);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-base);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.75rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            text-decoration: none; /* For links */
        }
        
        .btn-secondary:hover {
            background: var(--bg-hover);
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }
        
        /* Sidebar */
        .sidebar {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-width: 0; /* Necessary for grid collapse */
        }
        
        .sidebar-section {
            padding: 1.5rem 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .section-title {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }
        
        .device-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .device-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
        }
        
        .device-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--accent-primary);
            transform: scaleY(0);
            transition: transform var(--transition-base);
        }
        
        .device-card:hover {
            background: var(--bg-hover);
            border-color: var(--accent-primary);
            transform: translateX(4px);
        }
        
        .device-card:hover::before {
            transform: scaleY(1);
        }
        
        .device-card.active {
            background: var(--bg-hover);
            border-color: var(--accent-primary);
        }
        
        .device-card.active::before {
            transform: scaleY(1);
        }
        
        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
        }
        
        .device-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .device-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .device-status {
            font-size: 0.75rem;
            padding: 0.25rem 0.625rem;
            border-radius: 6px;
            font-weight: 600;
        }
        
        .device-status.online {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-success);
        }
        
        .device-status.offline {
            background: rgba(107, 114, 128, 0.15);
            color: var(--text-muted);
        }

        .ignition-icon {
            font-size: 1.2rem;
            line-height: 1;
        }
        
        .device-info {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }
        
        .device-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .info-label {
            color: var(--text-muted);
        }
        
        .info-value {
            font-family: var(--font-mono);
            font-weight: 500;
            color: var(--text-primary);
        }

        .device-actions {
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
        }

        /* Sidebar Close Button - Enhanced Visibility */
        .sidebar-close-btn {
            width: 32px; 
            height: 32px; 
            font-size: 1.2rem; 
            border: 1px solid var(--border-color); 
            background: var(--bg-hover); 
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-close-btn:hover {
            background: var(--accent-danger);
            border-color: var(--accent-danger);
            color: white;
        }

        /* History Details View */
        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .detail-item {
            background: var(--bg-tertiary);
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        .detail-key {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }
        .detail-val {
            font-size: 0.95rem;
            font-weight: 600;
            font-family: var(--font-mono);
        }
        .attr-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        .attr-table tr {
            border-bottom: 1px solid var(--border-color);
        }
        .attr-table tr:last-child {
            border-bottom: none;
        }
        .attr-table td {
            padding: 0.5rem 0;
        }
        .attr-key {
            color: var(--text-secondary);
            font-weight: 500;
        }
        .attr-val {
            font-family: var(--font-mono);
            text-align: right;
            color: var(--accent-primary);
        }
        
        /* Main Content */
        .main-content {
            display: grid;
            grid-template-rows: 1fr; /* REMOVED auto row for bottom bar */
            overflow: hidden;
        }
        
        .map-container {
            position: relative;
            background: var(--bg-tertiary);
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .map-controls {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        /* Contextual History Controls (only show when history active) */
        .history-controls {
            position: absolute;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(31, 41, 55, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 1rem 1.5rem;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            min-width: 400px;
            animation: slideUp 0.3s ease-out;
        }

        .history-controls-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .history-time {
            font-family: var(--font-mono);
            font-size: 0.875rem;
            color: var(--text-primary);
            background: rgba(0, 0, 0, 0.2);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }
        
        .history-slider {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: var(--bg-hover);
            border-radius: 3px;
            outline: none;
        }
        
        .history-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent-primary);
            cursor: pointer;
            transition: transform 0.1s;
        }
        
        .history-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }
        
        .control-panel {
            background: rgba(31, 41, 55, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: var(--shadow-lg);
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .control-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }
        
        .btn-group {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-icon {
            width: 40px;
            height: 40px;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-base);
            font-size: 1.125rem;
        }
        
        .btn-icon:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            transform: scale(1.05);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 14, 26, 0.8);
            backdrop-filter: blur(8px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            animation: fadeIn var(--transition-base);
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            max-width: 900px; /* Increased from 600px */
            width: 95%; /* Increased from 90% */
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: slideUp var(--transition-base);
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-base);
        }
        
        .modal-close:hover {
            background: var(--accent-danger);
            color: white;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: var(--font-display);
            font-size: 0.9375rem;
            transition: all var(--transition-base);
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Alerts Panel */
        .alerts-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-height: 400px;
            overflow-y: auto;
            overflow-x: hidden; /* Fix horizontal scrollbar */
        }
        
        .alert-item {
            background: var(--bg-tertiary);
            border-left: 4px solid var(--accent-primary);
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            gap: 1rem;
            align-items: start;
            transition: all var(--transition-base);
            position: relative; /* For dismiss button absolute pos */
        }
        
        .alert-item:hover {
            background: var(--bg-hover);
            /* Removed translate to prevent overflow */
        }
        
        .alert-item.warning {
            border-left-color: var(--accent-warning);
        }
        
        .alert-item.critical {
            border-left-color: var(--accent-danger);
        }
        
        .alert-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
        }
        
        .alert-item.info .alert-icon {
            background: rgba(59, 130, 246, 0.15);
            color: var(--accent-primary);
        }
        
        .alert-item.warning .alert-icon {
            background: rgba(245, 158, 11, 0.15);
            color: var(--accent-warning);
        }
        
        .alert-item.critical .alert-icon {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-danger);
        }
        
        .alert-content {
            flex: 1;
        }
        
        .alert-dismiss {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.25rem;
            font-size: 1.2rem;
            line-height: 1;
            transition: color 0.2s;
        }
        
        .alert-dismiss:hover {
            color: var(--text-primary);
        }
        
        .alert-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .alert-message {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .alert-time {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
            font-family: var(--font-mono);
        }
        
        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Toast Notification */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            z-index: 3000;
        }
        
        .toast {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: var(--shadow-lg);
            animation: slideInRight 0.3s ease-out;
            min-width: 300px;
        }
        
        .toast-icon {
            font-size: 1.25rem;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            font-size: 0.9375rem;
        }
        
        .toast-message {
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--bg-hover);
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr;
                grid-template-rows: 70px auto 1fr;
            }

            .dashboard.sidebar-hidden {
                grid-template-rows: 70px 0px 1fr; /* Collapse sidebar row */
            }

            .sidebar {
                grid-row: 2;
                max-height: 300px;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                transition: max-height 0.3s ease-out, opacity 0.3s ease-out, padding 0.3s;
                overflow: hidden; /* Ensure content hides */
            }

            .dashboard.sidebar-hidden .sidebar {
                max-height: 0;
                padding: 0;
                border: none;
                opacity: 0;
            }
            
            .main-content {
                grid-row: 3;
            }
        }
    </style>
</head>
<body>
    <!-- Dashboard Layout -->
    <div class="dashboard">
        <!-- Header -->
        <header class="header">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <button class="btn-icon" onclick="toggleSidebar()" style="border:none; background: transparent; color: var(--text-primary); font-size: 1.25rem; width: auto; height: auto;">‚ò∞</button>
                <div class="logo">
                    <div class="logo-icon">üõ∞Ô∏è</div>
                    <span>GPS Fleet Tracker</span>
                </div>
            </div>
            
            <div class="header-actions">
                <!-- Status indicator removed as requested -->
                <div class="status-indicator" style="display: none;">
                    <span class="status-dot"></span>
                    <span id="connectionStatus">Connected</span>
                </div>
                <!-- User Settings Button -->
                <a href="user-settings.html" class="btn btn-icon" title="Settings" style="width: auto; padding: 0.5rem; text-decoration: none; color: inherit;">
                    ‚öôÔ∏è
                </a>
                <a href="device-management.html" class="btn btn-secondary">
                    ‚öôÔ∏è Manage Devices
                </a>
                <button class="btn btn-primary" onclick="openAlertsModal()">
                    üîî Alerts(<span id="alertCount" style="display:none;">0</span>)
                </button>
                <!-- ADDED: Logout Button -->
                <button class="btn btn-secondary" onclick="handleLogout()" style="margin-left: 0.5rem;">
                    Logout
                </button>
            </div>
        </header>
        
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-section" id="sidebarDeviceList">
                <h3 class="section-title">Active Devices</h3>
                <div class="device-list" id="deviceList">
                    <!-- Devices will be populated here -->
                </div>
            </div>

            <!-- History Point Details View (Hidden by default) -->
            <div class="sidebar-section" id="sidebarHistoryDetails" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 class="section-title" id="historyDeviceName" style="margin-bottom: 0;">History Details</h3>
                    <button class="sidebar-close-btn" onclick="exitHistoryMode()" title="Close History">‚úï</button>
                </div>
                <div id="pointDetailsContent">
                    <!-- Dynamic content -->
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Map -->
            <div class="map-container">
                <div id="map"></div>
                
                <!-- REMOVED Map Controls Overlay (View/Playback) -->

                <!-- Floating History Controls (Shown when history is active) -->
                <div id="historyControls" class="history-controls" style="display: none;">
                    <div class="history-controls-top">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span style="font-weight: 600; color: var(--accent-primary);">History Mode</span>
                            <span id="historyTimestamp" class="history-time">--:--:--</span>
                        </div>
                        <div class="btn-group">
                            <button class="btn-icon" onclick="stepHistory(-1)" title="Previous Event">‚èÆ</button>
                            <button class="btn-icon" onclick="togglePlayback()" id="playbackBtn" title="Play/Pause">‚ñ∂Ô∏è</button>
                            <button class="btn-icon" onclick="stepHistory(1)" title="Next Event">‚è≠</button>
                            <button class="btn-icon" onclick="exitHistoryMode()" title="Exit History" style="margin-left: 0.5rem; background: var(--bg-hover);">‚úï</button>
                        </div>
                    </div>
                    <input type="range" class="history-slider" id="historySlider" min="0" max="100" value="0" oninput="seekHistory(this.value)">
                </div>
            </div>
        </main>
    </div>
    
    <!-- Alerts Modal -->
    <div class="modal" id="alertsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Recent Alerts</h2>
                <div style="display:flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="clearAllAlerts()">Clear All</button>
                    <button class="modal-close" onclick="closeAlertsModal()">‚úï</button>
                </div>
            </div>
            <div class="alerts-list" id="alertsList">
                <!-- Alerts will be populated here -->
            </div>
        </div>
    </div>
    
    <!-- History Selection Modal -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">View History</h2>
                <button class="modal-close" onclick="closeHistoryModal()">‚úï</button>
            </div>
            <form onsubmit="handleHistorySubmit(event)">
                <div class="form-group">
                    <label class="form-label">Quick Select</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="button" class="btn btn-secondary" onclick="setHistoryRange(1)">Last Hour</button>
                        <button type="button" class="btn btn-secondary" onclick="setHistoryRange(24)">Last 24 Hours</button>
                        <button type="button" class="btn btn-secondary" onclick="setHistoryRange(48)">Last 48 Hours</button>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Start Time</label>
                        <input type="datetime-local" class="form-input" id="historyStart" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">End Time</label>
                        <input type="datetime-local" class="form-input" id="historyEnd" required>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: flex-end; margin-top: 1rem;">
                    <button type="submit" class="btn btn-primary">Load History</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Device Details Modal -->
    <div class="modal" id="deviceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="deviceModalTitle">Device Details</h2>
                <button class="modal-close" onclick="closeDeviceModal()">‚úï</button>
            </div>
            <div id="deviceModalContent">
                <!-- Device details will be populated here -->
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // Configuration
        const API_BASE = 'http://localhost:8000/api';
        const WS_URL = 'ws://localhost:8000/ws/'; 
        
        // Vehicle Type Icons Mapping
        const VEHICLE_ICONS = {
            car: 'üöó',
            truck: 'üöõ',
            van: 'üöê',
            motorcycle: 'üèçÔ∏è',
            bus: 'üöå',
            person: 'üö∂',
            airplane: '‚úàÔ∏è',
            bicycle: 'üö≤',
            boat: 'üö¢',
            scooter: 'üõ¥',
            tractor: 'üöú',
            arrow: '‚ñ≤', // This will be rendered as SVG on map
            other: 'üì¶'
        };

        // State
        let map = null;
        let markers = {};
        let polylines = {};
        let ws = null;
        let devices = [];
        let selectedDevice = null;
        let historyDeviceId = null;
        let playbackInterval = null;
        let historyData = [];
        let historyIndex = 0;
        let loadedAlerts = [];
        let currentUser = null;
        
        // Helper to format dates to local time
        function formatDateToLocal(dateString) {
            if (!dateString) return 'N/A';
            if (dateString.indexOf('Z') === -1 && dateString.indexOf('+') === -1) {
                dateString += 'Z';
            }
            return new Date(dateString).toLocaleString();
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            checkLogin(); 
            initMap();
            await loadDevices();
            connectWebSocket();
            loadAlerts(); 
            startPeriodicUpdate();
        });

        // ADDED: Login Check Function
        function checkLogin() {
            const token = localStorage.getItem('auth_token');
            const userId = localStorage.getItem('user_id');
            
            if (!token || !userId) {
                window.location.href = 'login.html';
            } else {
                currentUser = { id: userId };
            }
        }

        // ADDED: Logout Function
        function handleLogout() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_id');
            localStorage.removeItem('username');
            window.location.href = 'login.html';
        }
        
        // Initialize Leaflet Map
        function initMap() {
            map = L.map('map').setView([37.7749, -122.4194], 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
        }
        
        // Load Devices
        async function loadDevices() {
            try {
                // FIXED: Use user_id from localStorage
                const userId = localStorage.getItem('user_id');
                const response = await fetch(`${API_BASE}/devices?user_id=${userId}`);
                if (!response.ok) {
                    if (response.status === 401) {
                        handleLogout(); // Token invalid
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                devices = await response.json();
                
                renderDeviceList();
                
                // Load state for each device
                for (const device of devices) {
                    await loadDeviceState(device.id);
                }
                
                updateStats();
            } catch (error) {
                console.error('Error loading devices:', error);
                
                // Update UI to show error (simplified logic since we hide indicator)
                showAlert({ title: 'Connection Failed', message: 'Unable to connect to the server.', type: 'error' });
            }
        }
        
        // Load Device State
        async function loadDeviceState(deviceId) {
            try {
                const response = await fetch(`${API_BASE}/devices/${deviceId}/state`);
                const state = await response.json();
                
                updateDeviceMarker(deviceId, state);
            } catch (error) {
                console.error(`Error loading state for device ${deviceId}:`, error);
            }
        }
        
        // Render Device List
        function renderDeviceList() {
            const list = document.getElementById('deviceList');
            list.innerHTML = '';
            
            if (devices.length === 0) {
                list.innerHTML = '<div style="padding: 1rem; color: var(--text-muted); text-align: center;">No devices assigned to this user.</div>';
                return;
            }
            
            devices.forEach(device => {
                const card = document.createElement('div');
                card.className = 'device-card';
                card.onclick = () => selectDevice(device.id);
                
                const vehicleIcon = VEHICLE_ICONS[device.vehicle_type] || 'üìç';
                const ignIcon = device.ignition_on ? 'üî•' : 'üÖøÔ∏è';

                card.innerHTML = `
                    <div class="device-header">
                        <div class="device-name">${vehicleIcon} ${device.name}</div>
                        <div class="device-meta">
                            <span class="ignition-icon" id="ign-icon-${device.id}">${ignIcon}</span>
                            <div class="device-status ${device.is_online ? 'online' : 'offline'}" id="status-${device.id}">
                                ${device.is_online ? 'Online' : 'Offline'}
                            </div>
                        </div>
                    </div>
                    <div class="device-info">
                        <div class="device-info-row">
                            <span class="info-label">IMEI</span>
                            <span class="info-value">${device.imei}</span>
                        </div>
                        <div class="device-info-row">
                            <span class="info-label">Protocol</span>
                            <span class="info-value">${device.protocol}</span>
                        </div>
                        ${device.license_plate ? `
                        <div class="device-info-row">
                            <span class="info-label">Plate</span>
                            <span class="info-value">${device.license_plate}</span>
                        </div>
                        ` : ''}
                    </div>
                    <div class="device-actions" style="margin-top: 1rem; border-top: 1px solid var(--border-color); padding-top: 0.75rem;">
                        <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); openHistoryModal(${device.id})">üïí History</button>
                    </div>
                `;
                
                list.appendChild(card);
            });
        }
        
        // Select Device
        function selectDevice(deviceId) {
            selectedDevice = deviceId;
            document.querySelectorAll('.device-card').forEach(card => card.classList.remove('active'));
            const marker = markers[deviceId];
            if (marker) {
                map.setView(marker.getLatLng(), 15);
                marker.openPopup();
            }
        }

        // Helper to generate custom marker HTML
        function getMarkerHtml(type, heading, ignitionOn) {
            let iconContent = VEHICLE_ICONS[type] || 'üìç';
            let rotationStyle = '';

            if (type === 'arrow') {
                // Clear high-contrast SVG arrow
                iconContent = `
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" 
                         style="transform: rotate(${heading}deg); transition: transform 0.3s; filter: drop-shadow(0px 2px 2px rgba(0,0,0,0.5));">
                        <path d="M12 2L4.5 20.29L5.21 21L12 18L18.79 21L19.5 20.29L12 2Z" 
                              fill="#3b82f6" stroke="white" stroke-width="1.5" stroke-linejoin="round"/>
                    </svg>
                `;
            } else {
                iconContent = `<div style="font-size: 28px;">${iconContent}</div>`;
            }

            return `
                <div class="marker-container" style="position: relative; display: flex; align-items: center; justify-content: center;">
                    ${iconContent}
                    <div style="position: absolute; bottom: -2px; right: -2px; width: 10px; height: 10px; background: ${ignitionOn ? 'var(--accent-success)' : 'var(--text-muted)'}; border-radius: 50%; border: 2px solid var(--bg-primary);"></div>
                </div>
            `;
        }
        
        // Update Device Marker
        function updateDeviceMarker(deviceId, state) {
            if (!state.last_latitude || !state.last_longitude) return;
            
            const position = [state.last_latitude, state.last_longitude];
            const device = devices.find(d => d.id === deviceId);
            const deviceName = device ? device.name : 'Unknown Device';
            const vehicleIcon = VEHICLE_ICONS[device?.vehicle_type] || 'üìç';
            const heading = state.last_course || 0;
            
            const popupContent = `
                <strong>${deviceName}</strong><br>
                Coords: ${state.last_latitude.toFixed(5)}, ${state.last_longitude.toFixed(5)}<br>
                Satellites: ${state.satellites || 0} | Alt: ${Math.round(state.last_altitude || 0)}m<br>
                ${state.ignition_on ? 'üü¢ Ignition ON' : 'üî¥ Ignition OFF'}<br>
                <small style="color:var(--text-muted);">Updated: ${formatDateToLocal(state.last_update)}</small>
            `;

            const icon = L.divIcon({
                html: getMarkerHtml(device?.vehicle_type, heading, state.ignition_on),
                className: 'custom-marker',
                iconSize: [36, 36],
                iconAnchor: [18, 18]
            });
            
            if (markers[deviceId]) {
                markers[deviceId].setLatLng(position);
                markers[deviceId].setIcon(icon);
                markers[deviceId].setPopupContent(popupContent);
            } else {
                markers[deviceId] = L.marker(position, { icon }).bindPopup(popupContent).addTo(map);
            }
            
            const deviceIndex = devices.findIndex(d => d.id === deviceId);
            if (deviceIndex !== -1) {
                if (!state.hasOwnProperty('is_online') && state.last_latitude) state.is_online = true;
                devices[deviceIndex] = { ...devices[deviceIndex], ...state };
                const statusEl = document.getElementById(`status-${deviceId}`);
                if (statusEl) {
                    const isOnline = devices[deviceIndex].is_online;
                    statusEl.className = `device-status ${isOnline ? 'online' : 'offline'}`;
                    statusEl.textContent = isOnline ? 'Online' : 'Offline';
                }
                const ignEl = document.getElementById(`ign-icon-${deviceId}`);
                if (ignEl) ignEl.textContent = state.ignition_on ? 'üî•' : 'üÖøÔ∏è';
            }
        }
        
        // WebSocket Connection
        function connectWebSocket() {
            // Use user ID from localStorage
            const userId = localStorage.getItem('user_id');
            if (!userId) return;

            ws = new WebSocket(`${WS_URL}${userId}`);
            ws.onopen = () => { document.getElementById('connectionStatus').textContent = 'Connected'; };
            ws.onmessage = (event) => handleWebSocketMessage(JSON.parse(event.data));
            ws.onerror = () => { console.error('WS Error'); };
            ws.onclose = () => { setTimeout(connectWebSocket, 5000); };
        }
        
        function handleWebSocketMessage(message) {
            if (message.type === 'position_update') {
                updateDeviceMarker(message.device_id, message.data);
                updateStats();
            } else if (message.type === 'alert') {
                let title = message.data.type.replace('_', ' ').toUpperCase();
                if (message.data.type === 'custom' && message.data.alert_metadata?.name) title = message.data.alert_metadata.name;
                showAlert({ title: title, message: message.data.message, type: message.data.severity || 'info' });
                loadAlerts();
            }
        }
        
        // --- HISTORY FUNCTIONS ---
        function openHistoryModal(deviceId) {
            historyDeviceId = deviceId;
            setHistoryRange(24);
            document.getElementById('historyModal').classList.add('active');
        }

        function closeHistoryModal() { document.getElementById('historyModal').classList.remove('active'); }

        function setHistoryRange(hours) {
            const now = new Date();
            const end = new Date();
            end.setHours(23, 59, 59, 999);
            const start = new Date(now.getTime() - hours * 60 * 60 * 1000);
            const fmt = d => new Date(d.getTime() - d.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            document.getElementById('historyStart').value = fmt(start);
            document.getElementById('historyEnd').value = fmt(end);
        }

        async function handleHistorySubmit(e) {
            e.preventDefault();
            const start = new Date(document.getElementById('historyStart').value);
            const end = new Date(document.getElementById('historyEnd').value);
            await loadHistory(historyDeviceId, start, end);
            closeHistoryModal();
        }

        async function loadHistory(deviceId, startTime, endTime) {
            if (polylines['history']) map.removeLayer(polylines['history']);
            if (markers['history_pos']) map.removeLayer(markers['history_pos']);
            stopPlayback();

            // Hide live marker for this device
            if (markers[deviceId]) {
                markers[deviceId].remove();
            }

            try {
                const response = await fetch(`${API_BASE}/positions/history`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device_id: deviceId, start_time: startTime.toISOString(), end_time: endTime.toISOString(), max_points: 2000 })
                });
                const data = await response.json();
                historyData = data.features;
                historyIndex = 0;
                if (historyData.length === 0) { showAlert({ title: 'History', message: 'No data found.', type: 'warning' }); return; }
                document.getElementById('historySlider').max = historyData.length - 1;
                document.getElementById('historySlider').value = 0;
                polylines['history'] = L.polyline(historyData.map(f => [f.geometry.coordinates[1], f.geometry.coordinates[0]]), { color: '#ef4444', weight: 4, opacity: 0.8 }).addTo(map);
                map.fitBounds(polylines['history'].getBounds());
                document.getElementById('historyControls').style.display = 'flex';
                document.getElementById('sidebarDeviceList').style.display = 'none';
                document.getElementById('sidebarHistoryDetails').style.display = 'block';
                const device = devices.find(d => d.id === deviceId);
                document.getElementById('historyDeviceName').textContent = device ? device.name : 'History Details';
                updatePlaybackUI();
            } catch (error) { showAlert({ title: 'Error', message: 'Failed to load history.', type: 'error' }); }
        }
        
        function exitHistoryMode() {
            stopPlayback();
            if (polylines['history']) map.removeLayer(polylines['history']);
            if (markers['history_pos']) map.removeLayer(markers['history_pos']);
            
            // Restore live marker
            if (markers[historyDeviceId]) {
                markers[historyDeviceId].addTo(map);
            }

            document.getElementById('historyControls').style.display = 'none';
            document.getElementById('sidebarDeviceList').style.display = 'block';
            document.getElementById('sidebarHistoryDetails').style.display = 'none';
        }

        function togglePlayback() { if (playbackInterval) stopPlayback(); else startPlayback(); }
        
        function startPlayback() {
            if (historyData.length === 0) return;
            document.getElementById('playbackBtn').textContent = '‚è∏Ô∏è';
            if (!markers['history_pos']) createHistoryMarker();
            playbackInterval = setInterval(() => {
                if (historyIndex >= historyData.length - 1) { stopPlayback(); return; }
                historyIndex++;
                updatePlaybackUI();
            }, 100);
        }
        
        function stopPlayback() {
            if (playbackInterval) { clearInterval(playbackInterval); playbackInterval = null; document.getElementById('playbackBtn').textContent = '‚ñ∂Ô∏è'; }
        }
        
        function seekHistory(value) { historyIndex = parseInt(value); stopPlayback(); updatePlaybackUI(); }
        function stepHistory(delta) {
            stopPlayback();
            historyIndex = Math.max(0, Math.min(historyData.length - 1, historyIndex + delta));
            updatePlaybackUI();
        }

        function updatePlaybackUI() {
            if (historyData.length === 0) return;
            const feature = historyData[historyIndex];
            const p = feature.properties;
            const position = [feature.geometry.coordinates[1], feature.geometry.coordinates[0]];
            const time = formatDateToLocal(p.time);
            const heading = p.course || 0;
            const device = devices.find(d => d.id === historyDeviceId);

            document.getElementById('historySlider').value = historyIndex;
            document.getElementById('historyTimestamp').textContent = time;
            
            if (!markers['history_pos']) createHistoryMarker();
            
            markers['history_pos'].setLatLng(position).setIcon(L.divIcon({
                html: getMarkerHtml(device?.vehicle_type, heading, p.ignition),
                className: 'history-marker',
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            })).bindPopup(`<strong>${time}</strong><br>Speed: ${p.speed} km/h<br>Alt: ${p.altitude} m`);
            
            updatePointDetails(feature);
        }

        function updatePointDetails(feature) {
            const p = feature.properties;
            const content = document.getElementById('pointDetailsContent');
            let html = `
                <div class="detail-grid">
                    <div class="detail-item"><span class="detail-key">Time</span><div class="detail-val">${formatDateToLocal(p.time)}</div></div>
                    <div class="detail-item"><span class="detail-key">Speed</span><div class="detail-val">${(p.speed || 0).toFixed(1)} km/h</div></div>
                    <div class="detail-item"><span class="detail-key">Lat/Lon</span><div class="detail-val">${feature.geometry.coordinates[1].toFixed(5)}, ${feature.geometry.coordinates[0].toFixed(5)}</div></div>
                    <div class="detail-item"><span class="detail-key">Altitude</span><div class="detail-val">${(p.altitude || 0).toFixed(0)} m</div></div>
                    <div class="detail-item"><span class="detail-key">Satellites</span><div class="detail-val">${p.satellites || 0}</div></div>
                    <div class="detail-item"><span class="detail-key">Ignition</span><div class="detail-val" style="color: ${p.ignition ? 'var(--accent-success)' : 'var(--text-muted)'}">${p.ignition ? 'ON' : 'OFF'}</div></div>
                </div>
            `;
            if (p.sensors && Object.keys(p.sensors).length > 0) {
                html += '<h4 style="font-size: 0.8rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.5rem;">Attributes</h4>';
                html += '<table class="attr-table"><tbody>';
                Object.keys(p.sensors).sort().forEach(key => { html += `<tr><td class="attr-key">${key}</td><td class="attr-val">${p.sensors[key]}</td></tr>`; });
                html += '</tbody></table>';
            } else html += '<div style="text-align: center; color: var(--text-muted); padding: 1rem; font-size: 0.875rem;">No additional attributes</div>';
            content.innerHTML = html;
        }

        function createHistoryMarker() {
            const device = devices.find(d => d.id === historyDeviceId);
            const vehicleIcon = VEHICLE_ICONS[device?.vehicle_type] || 'üü£';
            const heading = historyData[historyIndex].properties.course || 0;
            const rotationStyle = (device?.vehicle_type === 'arrow') ? `transform: rotate(${heading}deg);` : '';

            const icon = L.divIcon({
                html: `<div style="font-size: 28px; ${rotationStyle}">${vehicleIcon}</div>`,
                className: 'history-marker',
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });
            const startPos = historyData[historyIndex].geometry.coordinates;
            markers['history_pos'] = L.marker([startPos[1], startPos[0]], { icon }).addTo(map);
        }
        
        function updateStats() {}
        
        async function loadAlerts() {
            try {
                // FIXED: Use user_id from localStorage
                const userId = localStorage.getItem('user_id');
                const response = await fetch(`${API_BASE}/alerts?user_id=${userId}&unread_only=true`);
                loadedAlerts = await response.json();
                
                // Fix: Check length for displaying number inside parentheses
                const countEl = document.getElementById('alertCount');
                if (loadedAlerts.length > 0) {
                    countEl.textContent = loadedAlerts.length;
                    countEl.style.display = 'inline';
                } else {
                    countEl.textContent = '0';
                    countEl.style.display = 'inline'; // Always show 0 if loaded
                }

                const list = document.getElementById('alertsList');
                list.innerHTML = '';
                
                if (loadedAlerts.length === 0) {
                    list.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);">No alerts</div>';
                    return;
                }
                
                loadedAlerts.forEach(alert => {
                    const item = document.createElement('div');
                    item.className = `alert-item ${alert.severity}`;
                    const icon = { 'speeding': '‚ö°', 'geofence_enter': 'üìç', 'geofence_exit': 'üö™', 'offline': 'üì°', 'towing': 'üö®' }[alert.alert_type] || 'üîî';
                    
                    let title = alert.alert_type.replace('_', ' ').toUpperCase();
                    let messageText = alert.message;

                    if (alert.alert_type === 'custom' && alert.alert_metadata) {
                        if (alert.alert_metadata.name) {
                            title = alert.alert_metadata.name;
                        }
                        if (alert.alert_metadata.rule) {
                            messageText = alert.alert_metadata.rule;
                        }
                    }
                    
                    item.innerHTML = `
                        <div class="alert-icon">${icon}</div>
                        <div class="alert-content">
                            <div class="alert-title">${title}</div>
                            <div class="alert-message">${messageText}</div>
                            <div class="alert-time">${formatDateToLocal(alert.created_at)}</div>
                        </div>
                        <button class="alert-dismiss" onclick="dismissAlert(${alert.id})">‚úï</button>
                    `;
                    
                    list.appendChild(item);
                });
            } catch (error) {
                console.error('Error loading alerts:', error);
            }
        }
        
        function openAlertsModal() {
            loadAlerts();
            document.getElementById('alertsModal').classList.add('active');
        }
        
        function closeAlertsModal() {
            document.getElementById('alertsModal').classList.remove('active');
        }

        async function dismissAlert(alertId) {
            try {
                const res = await fetch(`${API_BASE}/alerts/${alertId}/read`, { method: 'POST' });
                if (res.ok) loadAlerts();
            } catch (e) {}
        }

        async function clearAllAlerts() {
            if (loadedAlerts.length === 0) return;
            if (!confirm('Mark all alerts as read?')) return;
            
            for (const alert of loadedAlerts) {
                try {
                    await fetch(`${API_BASE}/alerts/${alert.id}/read`, { method: 'POST' });
                } catch (e) {
                    console.error('Failed to clear alert', alert.id, e);
                }
            }
            
            loadAlerts();
            showAlert({ title: 'Success', message: 'All alerts cleared', type: 'success' });
        }
        
        function closeDeviceModal() {
            document.getElementById('deviceModal').classList.remove('active');
        }
        
        // Generic Alert/Toast Function
        function showAlert(data) {
            const message = typeof data === 'string' ? data : data.message;
            const title = data.title || 'Notification';
            const type = data.type || 'info';
            
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast`;
            
            // Icons
            const icons = {
                'success': '‚úì',
                'error': '‚úï',
                'warning': '‚ö†',
                'info': '‚Ñπ'
            };
            
            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || '‚Ñπ'}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s reverse forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // Toggle Sidebar function
        function toggleSidebar() {
            document.querySelector('.dashboard').classList.toggle('sidebar-hidden');
            setTimeout(() => {
                map.invalidateSize();
            }, 300);
        }

        // Periodic Updates
        function startPeriodicUpdate() {
            setInterval(() => {
                if (!ws || ws.readyState !== WebSocket.OPEN) {
                    // Fallback to polling if WebSocket is down
                    devices.forEach(device => loadDeviceState(device.id));
                }
                loadAlerts();
            }, 30000); // Every 30 seconds
        }
        
        // Traffic & Satellite (placeholder functions)
        function toggleTraffic() {
            alert('Traffic layer not implemented in demo');
        }
        
        function toggleSatellite() {
            alert('Satellite view not implemented in demo');
        }
    </script>
</body>
</html>