services:

  # ── Routario Application ─────────────────────────────────────────
  routario:
    image: bkbilly/routario:latest    # use 'build: .' during development
    build: .                          # uncomment to build locally instead
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    env_file: .env
    ports:
      # Web UI + API + WebSocket
      - "8000:8000"
      # GPS Protocol TCP Ports
      - "5021:5021"     # TK103
      - "5022:5022"     # GPS103
      - "5023:5023"     # GT06 / Concox
      - "5025:5025"     # H02
      - "5026:5026"     # Queclink
      - "5027:5027"     # Teltonika
      - "5028:5028"     # Totem
      - "5149:5149"     # Flespi
      # GPS Protocol UDP Ports
      - "5055:5055/udp" # OsmAnd
    volumes:
      - ./web:/app/web   # live-reload web assets without rebuild
    networks:
      - routario-net

  # ── PostgreSQL + PostGIS ─────────────────────────────────────────
  postgres:
    image: postgis/postgis:16-3.4-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB:       routario
      POSTGRES_USER:     routario
      POSTGRES_PASSWORD: ${DB_PASSWORD:-routariopass}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - routario-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U routario -d routario"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ── Redis ────────────────────────────────────────────────────────
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: redis-server --save 60 1 --loglevel warning
    volumes:
      - redis-data:/data
    networks:
      - routario-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres-data:
  redis-data:

networks:
  routario-net:
    driver: bridge
